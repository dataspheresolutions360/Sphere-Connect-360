<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SphereConnect 360 - Cloud Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <style>
        /* CORE VARIABLES */
        :root { --primary: #4f46e5; --whatsapp: #25D366; --dark: #0f172a; --bg: #f8fafc; --white: #ffffff; --border: #e2e8f0; --edit: #f59e0b; }
        
        /* BODY & RESET */
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: #334155; margin: 0; padding: 20px; overflow: hidden; /* Locked by default for login */ }
        .container { max-width: 1200px; margin: 0 auto; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { margin: 0; color: var(--dark); font-size: 1.5rem; }
        .subtitle { font-size: 0.6em; color: #64748b; font-weight: normal; }

        /* NAVIGATION */
        .nav { display: flex; gap: 10px; margin-bottom: 20px; background: #e2e8f0; padding: 5px; border-radius: 10px; }
        .nav-btn { flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; font-weight: bold; color: #64748b; border-radius: 8px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.6); }
        .nav-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* LAYOUTS */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        .card { background: var(--white); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        /* DASHBOARD STATS */
        .stat-card { background: white; padding: 20px; border-radius: 10px; border-left: 5px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-num { font-size: 2rem; font-weight: 800; color: var(--dark); display: block; }
        .stat-label { font-size: 0.85rem; color: #64748b; text-transform: uppercase; font-weight: bold; }
        .progress-container { background: #f1f5f9; border-radius: 5px; height: 10px; width: 100%; margin: 5px 0 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease; }
        .bar-new { background: #94a3b8; } .bar-contact { background: #3b82f6; } .bar-interest { background: #eab308; } .bar-sold { background: #22c55e; }

        /* FORMS & BUTTONS */
        input, select, textarea { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 14px; }
        label { font-size: 0.8em; font-weight: bold; color: #64748b; display: block; margin-bottom: 5px; }
        
        .btn { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; color: white; transition: 0.2s; font-size: 14px; }
        .btn-primary { background: var(--primary); }
        .btn-update { background: var(--edit); color: white; }
        .btn-cancel { background: #94a3b8; color: white; margin-left: 5px; }
        .btn-wa { background: var(--whatsapp); } .btn-wa:hover { background: #16a34a; }
        .btn-dark { background: #1e293b; }
        .btn-edit { background: var(--edit); padding: 5px 10px; font-size: 0.75em; margin-right: 5px;}
        .btn-del { background: #ef4444; font-size: 0.75em; padding: 5px 10px; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid var(--border); color: #64748b; font-size: 0.75em; text-transform: uppercase; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0f172a; display:flex; justify-content:center; align-items:center; z-index:9999;">
    <div style="background:white; padding:40px; border-radius:12px; text-align:center; width:350px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
        <h2 style="color:#4f46e5; margin-bottom:5px;">üåê SphereConnect 360</h2>
        <p style="color:#64748b; margin-top:0; font-size:0.9em;">Data Sphere Solutions Protected Area</p>
        
        <div style="margin:25px 0;">
            <input type="password" id="loginPass" placeholder="Enter Access Key" 
                   style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px; font-size:16px; outline:none; text-align:center;">
            <p id="loginError" style="color:red; font-size:0.8em; display:none; margin-top:10px;">‚ùå Invalid Access Key</p>
        </div>

        <button onclick="checkLogin()" style="background:#4f46e5; color:white; border:none; padding:12px 0; width:100%; border-radius:8px; font-weight:bold; cursor:pointer; font-size:16px;">
            Secure Login üîí
        </button>
        
        <p style="margin-top:20px; font-size:0.7em; color:#94a3b8;">
            Licensed to Data Sphere Solutions.<br>Unauthorized distribution prohibited.
        </p>
    </div>
</div>

<div class="container">
    <header>
        <h2>üìä SphereConnect 360 <span class="subtitle">by Data Sphere Solutions</span></h2>
        <div>
            <span style="font-size:0.8em; color:green; font-weight:bold; margin-right:10px;">üü¢ Live Sync</span>
            <button class="btn btn-dark" onclick="backupData()">‚¨á Backup</button>
            <input type="file" id="importFile" style="display:none" onchange="restoreData(this)">
            <button class="btn btn-dark" onclick="document.getElementById('importFile').click()">‚¨Ü Restore</button>
        </div>
    </header>

    <div class="nav">
        <button class="nav-btn active" onclick="switchTab('dashboard')">üìà Dashboard</button>
        <button class="nav-btn" onclick="switchTab('campaign')">üì¢ Campaigns</button>
        <button class="nav-btn" onclick="switchTab('clients')">üë• Clients</button>
        <button class="nav-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
    </div>

    <div id="dashboard" class="section active">
        <div class="grid-4" style="margin-bottom:20px;">
            <div class="stat-card" style="border-color: #3b82f6;">
                <span class="stat-num" id="d-total">...</span> <span class="stat-label">Total Clients</span>
            </div>
            <div class="stat-card" style="border-color: #eab308;">
                <span class="stat-num" id="d-apps">...</span> <span class="stat-label">Apps Inventory</span>
            </div>
            <div class="stat-card" style="border-color: #22c55e;">
                <span class="stat-num" id="d-sold">...</span> <span class="stat-label">Deals Closed</span>
            </div>
            <div class="stat-card" style="border-color: #6366f1;">
                <span class="stat-num" id="d-rate">...</span> <span class="stat-label">Conversion Rate</span>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <h3>Sales Pipeline</h3>
                <div style="font-size:0.85em; margin-bottom:2px;">New Leads <span id="l-new" style="float:right">0</span></div>
                <div class="progress-container"><div id="p-new" class="progress-bar bar-new" style="width:0%"></div></div>
                
                <div style="font-size:0.85em; margin-bottom:2px;">Contacted <span id="l-contact" style="float:right">0</span></div>
                <div class="progress-container"><div id="p-contact" class="progress-bar bar-contact" style="width:0%"></div></div>
                
                <div style="font-size:0.85em; margin-bottom:2px;">Interested <span id="l-interest" style="float:right">0</span></div>
                <div class="progress-container"><div id="p-interest" class="progress-bar bar-interest" style="width:0%"></div></div>
                
                <div style="font-size:0.85em; margin-bottom:2px;">Sold (Won) <span id="l-sold" style="float:right">0</span></div>
                <div class="progress-container"><div id="p-sold" class="progress-bar bar-sold" style="width:0%"></div></div>
            </div>
            <div class="card">
                <h3>Top Niches</h3>
                <div id="nicheList" style="max-height: 250px; overflow-y: auto;">Loading...</div>
            </div>
        </div>
    </div>

    <div id="campaign" class="section">
        <div class="card">
            <div style="background: #f0f9ff; border:1px solid #bae6fd; padding:15px; border-radius:8px; margin-bottom:20px;">
                <h3 style="margin-top:0; color:#0369a1;">1. Campaign Filter</h3>
                <div class="grid-4">
                    <div><label>Business Type</label><select id="campType" onchange="runFilter()"><option value="all">Show All</option></select></div>
                    <div><label>Status</label><select id="campStatus" onchange="reRenderTable()"><option value="all">Show All</option><option value="New">New</option><option value="Contacted">Contacted</option><option value="Interested">Interested</option><option value="Sold">Sold</option></select></div>
                    <div><label>App to Pitch</label><select id="campAppSelect" onchange="reRenderTable()" style="background:#e0f2fe; color:#0369a1; font-weight:bold;"><option value="">(Select Type First)</option></select></div>
                    <div style="display:flex; align-items:flex-end;"><button class="btn btn-primary" onclick="downloadCSV()" style="width:100%;">‚¨á CSV Export</button></div>
                </div>
            </div>

            <div class="grid-2">
                <div><label>Message Template</label><textarea id="msgTemplate" rows="4">Hello {name}, I noticed you run a {business}. We have a specialized app called "{app_name}" for you. Check demo here: {link}</textarea></div>
                <div><label>Variables</label><div style="font-size:0.85em; color:#666; background:#f8fafc; padding:10px; border-radius:6px;">{name}, {business}, {app_name}, {link}</div></div>
            </div>

            <h3>Target List (<span id="count">0</span>)</h3>
            <table><thead><tr><th>Client</th><th>Business</th><th>Status</th><th>Action</th></tr></thead><tbody id="campTable"></tbody></table>
        </div>
    </div>

    <div id="clients" class="section">
        <div class="card" id="clientFormCard">
            <h3 id="cFormTitle">Add New Client</h3>
            <input type="hidden" id="cId">
            <div class="grid-4">
                <input type="text" id="cName" placeholder="Name">
                <input type="text" id="cPhone" placeholder="Phone">
                <input type="text" id="cEmail" placeholder="Email">
                <select id="cType"><option>Select Type...</option></select>
            </div>
            <div style="margin-top:15px;">
                <button id="cBtn" class="btn btn-primary" onclick="saveClient()" style="width:200px;">+ Save Client</button>
                <button id="cCancel" class="btn btn-cancel" onclick="resetClientForm()" style="display:none;">Cancel</button>
            </div>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;"><h3>Client Database</h3><input type="text" id="cSearch" placeholder="üîç Search..." onkeyup="renderClients()" style="width:200px;"></div>
            <table><thead><tr><th>Name/Email</th><th>Phone</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead><tbody id="clientTable"></tbody></table>
        </div>
    </div>

    <div id="settings" class="section">
        <div class="grid-2">
            <div class="card" id="typeFormCard">
                <h3>1. Business Types</h3>
                <input type="hidden" id="tId">
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="tName" placeholder="e.g. Clinic">
                    <button id="tBtn" class="btn btn-primary" onclick="saveType()">Add</button>
                    <button id="tCancel" class="btn btn-cancel" onclick="resetTypeForm()" style="display:none;">X</button>
                </div>
                <div id="typeList" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
            </div>
            <div class="card" id="appFormCard">
                <h3>2. App Inventory</h3>
                <input type="hidden" id="aId">
                <div style="display:grid; gap:8px;">
                    <input type="text" id="aName" placeholder="App Name">
                    <select id="aLinkType"><option>Link to Type...</option></select>
                    <input type="text" id="aLink" placeholder="Demo Link">
                    <div style="display:flex;">
                        <button id="aBtn" class="btn btn-primary" style="flex:1" onclick="saveApp()">Save App</button>
                        <button id="aCancel" class="btn btn-cancel" onclick="resetAppForm()" style="display:none;">Cancel</button>
                    </div>
                </div>
                <div id="appList" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. FIREBASE CONFIG (YOUR KEYS) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAmBWUj4C0g9sp9tq30FbhxK2iJVKKeUaU",
      authDomain: "sphereconnect-360.firebaseapp.com",
      projectId: "sphereconnect-360",
      storageBucket: "sphereconnect-360.firebasestorage.app",
      messagingSenderId: "526979565250",
      appId: "1:526979565250:web:38d639a10bf7e53b5e9d5b",
      measurementId: "G-SH8DWSEPGC"
    };

    // Initialize Firebase (Compat Mode for Desktop File support)
    const app = firebase.initializeApp(firebaseConfig);
    const dbFS = firebase.firestore();
    const analytics = firebase.analytics();

    // --- 2. LOCAL STATE MIRROR ---
    let db = { types: [], apps: [], clients: [] };

    // --- 3. REALTIME LISTENERS ---
    dbFS.collection("types").onSnapshot(snap => {
        db.types = snap.docs.map(d => ({id: d.id, ...d.data()}));
        refreshAll();
    });
    dbFS.collection("apps").onSnapshot(snap => {
        db.apps = snap.docs.map(d => ({id: d.id, ...d.data()}));
        refreshAll();
    });
    dbFS.collection("clients").onSnapshot(snap => {
        db.clients = snap.docs.map(d => ({id: d.id, ...d.data()}));
        refreshAll();
    });

    // --- 4. GLOBAL FUNCTIONS ---
    function refreshAll() {
        populateDropdowns(); renderTypes(); renderApps(); renderClients(); runFilter(); renderDashboard();
    }

    // Business Types
    window.saveType = function() {
        const id = document.getElementById('tId').value; 
        const name = document.getElementById('tName').value;
        if(!name) return;
        
        if(id) { dbFS.collection("types").doc(id).update({name}); } 
        else { dbFS.collection("types").add({name}); }
        resetTypeForm();
    };
    window.deleteType = function(id) { if(confirm('Delete Type?')) dbFS.collection("types").doc(id).delete(); };
    window.editType = function(id) {
        const t = db.types.find(x=>x.id==id);
        document.getElementById('tId').value = t.id; 
        document.getElementById('tName').value = t.name;
        document.getElementById('tBtn').innerText = "Update"; 
        document.getElementById('tBtn').className = "btn btn-update"; 
        document.getElementById('tCancel').style.display = "inline";
    };
    window.resetTypeForm = function() {
        document.getElementById('tId').value=''; 
        document.getElementById('tName').value='';
        document.getElementById('tBtn').innerText="Add"; 
        document.getElementById('tBtn').className="btn btn-primary"; 
        document.getElementById('tCancel').style.display="none";
    };

    // Apps
    window.saveApp = function() {
        const id = document.getElementById('aId').value;
        const name = document.getElementById('aName').value;
        const typeId = document.getElementById('aLinkType').value;
        const link = document.getElementById('aLink').value;
        if(!name || !typeId) return;

        if(id) { dbFS.collection("apps").doc(id).update({name, typeId, link}); }
        else { dbFS.collection("apps").add({name, typeId, link}); }
        resetAppForm();
    };
    window.deleteApp = function(id) { if(confirm('Delete App?')) dbFS.collection("apps").doc(id).delete(); };
    window.editApp = function(id) {
        const a = db.apps.find(x=>x.id==id);
        document.getElementById('aId').value = a.id; 
        document.getElementById('aName').value = a.name; 
        document.getElementById('aLinkType').value = a.typeId; 
        document.getElementById('aLink').value = a.link;
        document.getElementById('aBtn').innerText = "Update"; 
        document.getElementById('aBtn').className = "btn btn-update"; 
        document.getElementById('aCancel').style.display = "inline";
    };
    window.resetAppForm = function() {
        document.getElementById('aId').value=''; 
        document.getElementById('aName').value=''; 
        document.getElementById('aLink').value='';
        document.getElementById('aBtn').innerText="Save"; 
        document.getElementById('aBtn').className="btn btn-primary"; 
        document.getElementById('aCancel').style.display="none";
    };

    // Clients
    window.saveClient = function() {
        const id = document.getElementById('cId').value;
        const n = document.getElementById('cName').value;
        const p = document.getElementById('cPhone').value;
        const e = document.getElementById('cEmail').value;
        const t = document.getElementById('cType').value;
        if(!n) return;

        if(id) { dbFS.collection("clients").doc(id).update({name:n, phone:p, email:e, typeId:t}); }
        else { dbFS.collection("clients").add({name:n, phone:p, email:e, typeId:t, status:'New', date: new Date().toISOString()}); }
        resetClientForm();
    };
    window.deleteClient = function(id) { if(confirm('Delete Client?')) dbFS.collection("clients").doc(id).delete(); };
    window.updateStatus = function(id, newStatus) { dbFS.collection("clients").doc(id).update({status: newStatus}); };
    window.editClient = function(id) {
        const c = db.clients.find(x=>x.id==id);
        document.getElementById('cId').value = c.id; 
        document.getElementById('cName').value = c.name; 
        document.getElementById('cPhone').value = c.phone; 
        document.getElementById('cEmail').value = c.email; 
        document.getElementById('cType').value = c.typeId;
        document.getElementById('cFormTitle').innerText = "Edit Client";
        document.getElementById('cBtn').innerText = "Update"; 
        document.getElementById('cBtn').className = "btn btn-update"; 
        document.getElementById('cCancel').style.display = "inline";
        document.getElementById('clientFormCard').scrollIntoView();
    };
    window.resetClientForm = function() {
        document.getElementById('cId').value=''; 
        document.getElementById('cName').value=''; 
        document.getElementById('cPhone').value=''; 
        document.getElementById('cEmail').value='';
        document.getElementById('cFormTitle').innerText="Add Client";
        document.getElementById('cBtn').innerText="+ Save"; 
        document.getElementById('cBtn').className="btn btn-primary"; 
        document.getElementById('cCancel').style.display="none";
    };

    // UI Rendering
    window.renderTypes = function() {
        document.getElementById('typeList').innerHTML = db.types.map(t => 
            `<span style="background:#eee; padding:5px 10px; border-radius:15px; font-size:0.85em;">
                ${t.name} <span onclick="editType('${t.id}')" style="cursor:pointer; color:#f59e0b; margin-left:5px;">‚úé</span> 
                <span onclick="deleteType('${t.id}')" style="color:red; cursor:pointer;">&times;</span>
             </span>`
        ).join('');
    };

    window.renderApps = function() {
        document.getElementById('appList').innerHTML = db.apps.map(a => {
            const t = db.types.find(x => x.id == a.typeId);
            return `<div style="padding:5px 0; border-bottom:1px solid #f1f5f9;">
                <strong>${a.name}</strong> (${t ? t.name : '-'}) 
                <button class="btn btn-del" onclick="deleteApp('${a.id}')" style="float:right;">Del</button>
                <button class="btn btn-edit" onclick="editApp('${a.id}')" style="float:right;">Edit</button>
            </div>`;
        }).join('');
    };

    window.renderClients = function() {
        const s = document.getElementById('cSearch').value.toLowerCase();
        document.getElementById('clientTable').innerHTML = db.clients.map(c => {
            if(s && !c.name.toLowerCase().includes(s)) return '';
            const t = db.types.find(x => x.id == c.typeId);
            const color = c.status==='Sold'?'#dcfce7':c.status==='Interested'?'#fef9c3':c.status==='Contacted'?'#e0f2fe':'#fff';
            return `<tr>
                <td><b>${c.name}</b><br><small style="color:#64748b">${c.email||''}</small></td>
                <td>${c.phone}</td>
                <td>${t ? t.name : '-'}</td>
                <td>
                    <select onchange="updateStatus('${c.id}', this.value)" style="padding:5px; border-radius:5px; border:1px solid #ddd; background:${color}">
                        <option value="New" ${c.status==='New'?'selected':''}>New</option>
                        <option value="Contacted" ${c.status==='Contacted'?'selected':''}>Contacted</option>
                        <option value="Interested" ${c.status==='Interested'?'selected':''}>Interested</option>
                        <option value="Sold" ${c.status==='Sold'?'selected':''}>‚úÖ Sold</option>
                    </select>
                </td>
                <td>
                    <button class="btn btn-edit" onclick="editClient('${c.id}')">Edit</button>
                    <button class="btn btn-del" onclick="deleteClient('${c.id}')">Del</button>
                </td>
            </tr>`;
        }).join('');
    };

    window.populateDropdowns = function() {
        const opts = db.types.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        document.getElementById('campType').innerHTML = `<option value="all">Show All</option>` + opts;
        document.getElementById('cType').innerHTML = `<option value="">Select...</option>` + opts;
        document.getElementById('aLinkType').innerHTML = `<option value="">Link...</option>` + opts;
    };

    window.renderDashboard = function() {
        const total = db.clients.length;
        const sold = db.clients.filter(c => c.status === 'Sold').length;
        const totalApps = db.apps.length;
        const rate = total > 0 ? ((sold/total)*100).toFixed(1) : 0;
        
        document.getElementById('d-total').innerText = total;
        document.getElementById('d-apps').innerText = totalApps;
        document.getElementById('d-sold').innerText = sold;
        document.getElementById('d-rate').innerText = rate + '%';

        const counts = { New: 0, Contacted: 0, Interested: 0, Sold: 0 };
        db.clients.forEach(c => { if(counts[c.status] !== undefined) counts[c.status]++; });

        const setBar = (id, val) => {
            const pct = total > 0 ? (val/total)*100 : 0;
            document.getElementById('l-'+id).innerText = `${val} (${pct.toFixed(0)}%)`;
            document.getElementById('p-'+id).style.width = pct + '%';
        };
        setBar('new', counts.New); setBar('contact', counts.Contacted);
        setBar('interest', counts.Interested); setBar('sold', counts.Sold);

        const nicheCounts = {};
        db.clients.forEach(c => {
            const t = db.types.find(x => x.id == c.typeId);
            const name = t ? t.name : 'Unknown';
            nicheCounts[name] = (nicheCounts[name] || 0) + 1;
        });
        document.getElementById('nicheList').innerHTML = Object.entries(nicheCounts)
            .sort((a,b) => b[1] - a[1])
            .map(([n, c]) => `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #f1f5f9;"><span>${n}</span><span style="font-weight:bold;">${c}</span></div>`)
            .join('');
    };

    // Campaign Logic
    window.runFilter = function() {
        const typeId = document.getElementById('campType').value;
        const appSelect = document.getElementById('campAppSelect');
        appSelect.innerHTML = '';
        
        if(typeId !== 'all') {
            const matchingApps = db.apps.filter(a => a.typeId == typeId);
            if(matchingApps.length > 0) {
                matchingApps.forEach(app => {
                    const opt = document.createElement('option');
                    opt.value = app.id;
                    opt.innerText = app.name;
                    appSelect.appendChild(opt);
                });
                appSelect.value = matchingApps[0].id;
            } else {
                appSelect.innerHTML = '<option value="">No Apps Found</option>';
            }
        } else {
            appSelect.innerHTML = '<option value="">Generic / Mixed</option>';
        }
        reRenderTable();
    };

    window.reRenderTable = function() {
        const typeId = document.getElementById('campType').value;
        const status = document.getElementById('campStatus').value;
        const selectedAppId = document.getElementById('campAppSelect').value;
        const tbody = document.getElementById('campTable');
        
        let selectedApp = selectedAppId ? db.apps.find(a => a.id == selectedAppId) : null;
        
        const targets = db.clients.filter(c => {
            const mType = (typeId === 'all' || c.typeId == typeId);
            const mStat = (status === 'all' || c.status == status);
            return mType && mStat;
        });
        
        document.getElementById('count').innerText = targets.length;

        tbody.innerHTML = targets.map(c => {
            const t = db.types.find(x=>x.id==c.typeId);
            const tName = t ? t.name : 'Business';
            let appName = "our app"; 
            let appLink = "";

            if (selectedApp) {
                appName = selectedApp.name;
                appLink = selectedApp.link;
            } else if (typeId === 'all') {
                const specificApp = db.apps.find(a => a.typeId == c.typeId);
                if(specificApp) {
                    appName = specificApp.name;
                    appLink = specificApp.link;
                }
            }

            return `<tr>
                <td><strong>${c.name}</strong></td>
                <td>${tName}</td>
                <td>${c.status}</td>
                <td>
                    <button class="btn btn-wa" onclick="sendWA('${c.phone}','${c.name}','${tName}','${appName}','${appLink}', '${c.id}')">
                        WhatsApp üöÄ
                    </button>
                </td>
            </tr>`;
        }).join('');
    };

    window.sendWA = function(phone, name, bus, appName, link, id) {
        if(!phone) return alert("No phone");
        const c = db.clients.find(x=>x.id==id);
        if(c && c.status === 'New') {
            dbFS.collection("clients").doc(id).update({status: 'Contacted'});
        }
        let msg = document.getElementById('msgTemplate').value;
        msg = msg.replace(/{name}/g, name)
                 .replace(/{business}/g, bus)
                 .replace(/{app_name}/g, appName)
                 .replace(/{link}/g, link);
        window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
    };
    
    window.downloadCSV = function() {
        const typeId = document.getElementById('campType').value;
        const status = document.getElementById('campStatus').value;
        const targets = db.clients.filter(c => (typeId === 'all' || c.typeId == typeId) && (status === 'all' || c.status == status));
        
        if(targets.length === 0) return alert("No clients.");

        let csv = "Name,Email,Phone,Business Type,Status\n";
        targets.forEach(c => {
            const t = db.types.find(x=>x.id==c.typeId);
            const tName = t ? t.name : '-';
            csv += `${c.name.replace(/,/g,'')},${c.email||''},${c.phone},${tName},${c.status}\n`;
        });

        const a = document.createElement("a");
        a.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
        a.download = "SphereConnect_Export.csv";
        a.click();
    };

    // --- 7. UI TABS ---
    window.switchTab = function(id) {
        document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    };

    // --- 8. LOGIN LOGIC ---
    // (Ensure this password is secure for actual deployment)
    const DEMO_PASS = "demo360";

    // Check session
    if (sessionStorage.getItem("dss_auth") === "true") {
        document.getElementById('loginOverlay').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    window.checkLogin = function() {
        const p = document.getElementById('loginPass').value;
        if(p === DEMO_PASS) {
            document.getElementById('loginOverlay').style.display='none';
            document.body.style.overflow='auto';
            sessionStorage.setItem("dss_auth", "true");
        } else {
            document.getElementById('loginError').style.display='block';
        }
    };

    // Backup/Restore (Local only, not cloud)
    window.backupData = function() { 
        const a=document.createElement('a'); 
        a.href="data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); 
        a.download="Backup.json"; 
        a.click(); 
    };
    window.restoreData = function(i) { 
        const r=new FileReader(); 
        r.onload=e=>{
            try{
                // This updates local state only - does NOT overwrite cloud
                db=JSON.parse(e.target.result); 
                refreshAll(); 
                alert("Restored locally (not synced to cloud). To sync, add items manually.");
            }catch{alert("Error");}
        }; 
        r.readAsText(i.files[0]); 
    };

</script>
</body>
</html>